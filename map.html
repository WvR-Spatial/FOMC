<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>FoMC Interactive Map</title>
    
    <!-- Leaflet CSS -->
    <link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css" integrity="sha256-p4NxAoJBhIIN+hmNHrzRCf9tD/miZyoHS5obTRR9BMY=" crossorigin=""/>
    
    <!-- Fonts -->
    <link href="https://fonts.googleapis.com/css2?family=Roboto:wght@400;500;700&display=swap" rel="stylesheet">

    <style>
        /* --- RESET & LAYOUT --- */
        body, html { margin: 0; padding: 0; height: 100%; width: 100%; font-family: 'Roboto', sans-serif; overflow: hidden; }
        #map { height: 100%; width: 100%; background: #f0f0f0; }

        /* --- UI CONTROLS (Floating Panel - LEFT SIDE) --- */
        .map-controls {
            position: absolute;
            top: 20px;
            left: 20px; /* Moved to Left */
            background: white;
            padding: 0;
            border-radius: 8px;
            box-shadow: 0 4px 15px rgba(0,0,0,0.2);
            z-index: 1000;
            width: 280px;
            max-width: 85%;
            height: auto;
            max-height: 90vh;
            display: flex;
            flex-direction: column;
        }

        .controls-header {
            padding: 15px;
            border-bottom: 1px solid #eee;
            background: #f8f9fa;
            border-radius: 8px 8px 0 0;
        }

        .controls-content {
            padding: 15px;
            overflow-y: auto;
            flex-grow: 1;
        }

        .control-section { margin-bottom: 20px; border-bottom: 1px solid #eee; padding-bottom: 15px; }
        .control-section:last-child { border-bottom: none; margin-bottom: 0; }
        
        .control-title { font-weight: 700; margin-bottom: 10px; font-size: 13px; color: #2c3e50; text-transform: uppercase; letter-spacing: 0.5px; }
        
        /* Checkboxes */
        .filter-item { margin-bottom: 8px; display: flex; align-items: center; cursor: pointer; font-size: 14px; color: #444; }
        .filter-item input { margin-right: 10px; cursor: pointer; accent-color: #2c3e50; }
        
        /* Group List (Sidebar) */
        .group-list { list-style: none; padding: 0; margin: 0; }
        .group-list-item { 
            padding: 6px 8px; 
            cursor: pointer; 
            border-radius: 4px; 
            font-size: 13px; 
            color: #555; 
            transition: background 0.2s;
            display: flex;
            align-items: center;
        }
        .group-list-item:hover { background: #eef2f5; color: #000; }
        .group-dot { width: 8px; height: 8px; border-radius: 50%; margin-right: 8px; flex-shrink: 0;}

        /* --- GLOBAL UPCOMING EVENTS (Bottom Right Overlay) --- */
        .upcoming-overlay {
            position: absolute;
            bottom: 30px;
            right: 20px;
            width: 260px;
            background: white;
            border-radius: 8px;
            box-shadow: 0 4px 15px rgba(0,0,0,0.2);
            z-index: 1000;
            overflow: hidden;
        }
        .upcoming-header {
            background: #2c3e50;
            color: white;
            padding: 10px 15px;
            font-weight: bold;
            font-size: 14px;
        }
        .upcoming-list { padding: 0; margin: 0; max-height: 200px; overflow-y: auto; }
        .upcoming-item {
            padding: 10px 15px;
            border-bottom: 1px solid #eee;
            cursor: pointer;
            transition: background 0.2s;
        }
        .upcoming-item:hover { background: #f8f9fa; }
        .up-date { font-size: 11px; font-weight: bold; color: #27ae60; display: block; }
        .up-title { font-size: 13px; color: #333; display: block; margin-top: 2px; }
        .up-loc { font-size: 11px; color: #7f8c8d; }

        /* --- PINS & POPUPS --- */
        .pin-swatch { width: 12px; height: 12px; border-radius: 50%; margin-right: 8px; border: 2px solid white; box-shadow: 0 0 3px rgba(0,0,0,0.3); }
        .pin-yellow { background: #f1c40f; } 
        .pin-purple { background: #9b59b6; } 
        .pin-green { background: #2ecc71; } 
        
        .custom-pin {
            background-color: #fff;
            border: 2px solid #fff;
            border-radius: 50%;
            box-shadow: 0 2px 5px rgba(0,0,0,0.4);
        }
        .custom-pin.type-fomc { background-color: #f1c40f; }
        .custom-pin.type-partner { background-color: #9b59b6; }
        .custom-pin.type-other { background-color: #2ecc71; }

        .popup-header { font-weight: bold; font-size: 15px; color: #2c3e50; margin-bottom: 5px; border-bottom: 2px solid #eee; padding-bottom: 5px;}
        .popup-sub { font-size: 11px; text-transform: uppercase; color: #7f8c8d; margin-bottom: 5px; letter-spacing: 0.5px; }
        
        .popup-events-list { max-height: 120px; overflow-y: auto; }
        .popup-event { margin-top: 6px; font-size: 12px; background: #f9f9f9; padding: 6px; border-radius: 4px; border-left: 3px solid #2ecc71; }
        
        /* --- UTILS --- */
        .hidden { display: none !important; }
        
        #loader {
            position: absolute; top: 50%; left: 50%; transform: translate(-50%, -50%);
            background: rgba(255,255,255,0.95); padding: 25px; border-radius: 12px;
            z-index: 2000; box-shadow: 0 10px 30px rgba(0,0,0,0.2); text-align: center;
            min-width: 200px;
        }
        #error-log { font-size: 11px; color: #c0392b; margin-top: 10px; text-align: left; }
    </style>
</head>
<body>

    <div id="loader">
        <h3 style="margin:0 0 10px 0; color:#333;">Loading Map</h3>
        <div style="font-size: 0.9em; color: #666;">Syncing Google Calendar & Maps...</div>
        <div id="error-log"></div>
    </div>

    <div id="map"></div>

    <!-- LEFT SIDEBAR -->
    <div class="map-controls">
        <div class="controls-header">
            <h3 style="margin:0; font-size:16px;">Map Controls</h3>
        </div>
        
        <div class="controls-content">
            <!-- SECTION 1: LAYERS -->
            <div class="control-section">
                <div class="control-title">Filters</div>
                <label class="filter-item">
                    <input type="checkbox" id="chk-fomc" checked onchange="updateView()"> 
                    <span class="pin-swatch pin-yellow"></span> Working Groups
                </label>
                <label class="filter-item">
                    <input type="checkbox" id="chk-partner" checked onchange="updateView()"> 
                    <span class="pin-swatch pin-purple"></span> Partner Groups
                </label>
                <label class="filter-item">
                    <input type="checkbox" id="chk-other" checked onchange="updateView()"> 
                    <span class="pin-swatch pin-green"></span> Activity Sites
                </label>
            </div>

            <!-- SECTION 2: HOTSPOT -->
            <div class="control-section">
                <div class="control-title">Visualization</div>
                <label class="filter-item">
                    <input type="checkbox" id="chk-hotspot" onchange="updateView()"> 
                    <strong>Enable Activity Hotspot</strong>
                </label>
                <div style="font-size:11px; color:#666; margin-left:24px; line-height:1.4;">
                    Highlights most active areas (Past 12mo - Future 3mo). Hides markers.
                </div>
            </div>

            <!-- SECTION 3: GROUP LIST -->
            <div class="control-section">
                <div class="control-title">All Groups</div>
                <ul id="group-list-container" class="group-list">
                    <!-- Populated by JS -->
                </ul>
            </div>
            
            <div style="margin-top:15px; text-align:center;">
                <button onclick="window.print()" style="width:100%; padding:8px; cursor:pointer; background:#eee; border:1px solid #ccc; border-radius:4px;">Print / Export View</button>
           </div>
        </div>
    </div>

    <!-- GLOBAL NEXT EVENTS OVERLAY -->
    <div id="upcoming-overlay" class="upcoming-overlay">
        <div class="upcoming-header">Next 3 FoMC Events</div>
        <div id="upcoming-list" class="upcoming-list">
            <!-- Populated by JS -->
        </div>
    </div>

    <!-- SCRIPTS -->
    <script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js" integrity="sha256-20nQCchB9co0qIjJZRGuk2/Z9VM+kNiyxNV1lvTlZBo=" crossorigin=""></script>
    <script src="https://api.mapbox.com/mapbox.js/plugins/leaflet-omnivore/v0.3.1/leaflet-omnivore.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/ical.js/1.5.0/ical.min.js"></script>
    <!-- Leaflet Heatmap Plugin -->
    <script src="https://unpkg.com/leaflet.heat@0.2.0/dist/leaflet-heat.js"></script>

    <script>
        // --- CONFIGURATION ---
        const CORS_PROXY = "https://corsproxy.io/?"; 
        const KML_URL = "https://www.google.com/maps/d/u/0/kml?mid=1N4_do_WC-ikYZ3nO9BO7oz343c51fZs&forcekml=1";
        const ICAL_URL = "https://calendar.google.com/calendar/ical/friendsofmerricreek%40gmail.com/public/basic.ics";
        
        let map;
        let allMarkers = []; 
        let calendarEvents = [];
        let heatLayer;

        window.onload = init;

        async function init() {
            // Setup Map
            map = L.map('map', { zoomControl: false }).setView([-37.75, 144.98], 12); 
            L.control.zoom({ position: 'topright' }).addTo(map);
            L.tileLayer('https://{s}.basemaps.cartocdn.com/light_all/{z}/{x}/{y}{r}.png', {
                attribution: '&copy; OpenStreetMap &copy; CARTO',
                subdomains: 'abcd',
                maxZoom: 20
            }).addTo(map);

            // Load Data
            await loadContextLayer(); 
            await loadCalendarData(); 
            await loadMapPoints();    

            // Post-Load: Generate UI lists
            generateGroupList();
            generateGlobalUpcomingList();

            document.getElementById('loader').style.display = 'none';
        }

        async function loadContextLayer() {
            const myRenderer = L.svg({ padding: 2.0 });
            try {
                const response = await fetch('./merriCatchment_boundary.geojson'); 
                if(response.ok) {
                    const data = await response.json();
                    renderBoundary(data, myRenderer);
                    return;
                }
                throw new Error("Local file not found");
            } catch (e) { 
                console.log("Using Fallback Boundary.");
                // Fallback geometry
                const fallbackGeoJSON = { "type": "FeatureCollection", "features": [{ "type": "Feature", "geometry": { "type": "Polygon", "coordinates": [[ [144.96, -37.50], [145.02, -37.50], [145.05, -37.60], [145.02, -37.70], [145.00, -37.78], [144.98, -37.78], [144.95, -37.70], [144.92, -37.60], [144.96, -37.50] ]] } }] };
                renderBoundary(fallbackGeoJSON, myRenderer);
            }
        }

        function renderBoundary(data, renderer) {
            L.geoJSON(data, {
                renderer: renderer,
                style: { 
                    color: "#2c3e50", 
                    weight: 3, 
                    fillColor: "#000",
                    fillOpacity: 0.0, // Clear inside
                    dashArray: '5, 5' 
                },
                interactive: false 
            }).addTo(map);

            // CHANGED: Removed aggressive paddingTopLeft
            // Use standard padding to ensure snug fit
            const bounds = L.geoJSON(data).getBounds();
            map.fitBounds(bounds, { padding: [50, 50] });
        }

        async function loadCalendarData() {
            try {
                const proxyUrl = CORS_PROXY + encodeURIComponent(ICAL_URL);
                const response = await fetch(proxyUrl);
                if (!response.ok) throw new Error("HTTP " + response.status);
                
                const data = await response.text();
                const jcalData = ICAL.parse(data);
                const comp = new ICAL.Component(jcalData);
                calendarEvents = comp.getAllSubcomponents('vevent').map(event => {
                    const ev = new ICAL.Event(event);
                    return {
                        summary: ev.summary || "",
                        location: ev.location || "",
                        startDate: ev.startDate.toJSDate(),
                        description: ev.description || "",
                        lat: null, lng: null // Will be filled if matched to map
                    };
                });
                console.log(`Calendar loaded: ${calendarEvents.length} events.`);

            } catch (e) {
                console.error("Calendar Error:", e);
                // Fallback
                calendarEvents = [
                    {summary: "Community Planting", location: "Coburg Lake", startDate: new Date(Date.now() + 86400000)},
                    {summary: "Bird Survey", location: "Merri Park", startDate: new Date(Date.now() + 172800000)},
                    {summary: "Water Quality Test", location: "Edgars Creek", startDate: new Date(Date.now() + 259200000)}
                ]; 
            }
        }

        async function loadMapPoints() {
            try {
                const proxyUrl = CORS_PROXY + encodeURIComponent(KML_URL);
                const response = await fetch(proxyUrl);
                if (!response.ok) throw new Error("HTTP " + response.status);
                
                const kmlText = await response.text();
                const layer = omnivore.kml.parse(kmlText);
                const geojson = layer.toGeoJSON();
                
                geojson.features.forEach(feature => createSmartMarker(feature));

            } catch (e) {
                console.error("KML Error:", e);
                createSmartMarker({properties:{name:"FOMC @ Coburg Lake"}, geometry:{type:"Point", coordinates:[144.965, -37.733]}}, true);
            }
        }

        // --- CORE LOGIC ---

        function createSmartMarker(feature) {
            const rawName = feature.properties.name || "Unknown";
            const type = determineGroupType(rawName);
            
            let lat, lng;
            if (feature.geometry.type === "Point") {
                lng = feature.geometry.coordinates[0];
                lat = feature.geometry.coordinates[1];
            } else return;
            
            const coords = [lat, lng]; 

            // Matching Logic
            const eventsData = findEventsForGroup(rawName);
            
            // Assign coords to events for Hotspot logic
            eventsData.all.forEach(ev => { ev.lat = lat; ev.lng = lng; });

            // Create Icon
            const iconClass = `custom-pin type-${type}`;
            const customIcon = L.divIcon({
                className: iconClass,
                iconSize: [14, 14],
                iconAnchor: [7, 7],
                popupAnchor: [0, -10]
            });

            const marker = L.marker(coords, {icon: customIcon}).addTo(map);
            
            // Popup with Next 3 Events
            const next3 = eventsData.future.slice(0, 3);
            marker.bindPopup(generatePopupHtml(rawName, type, next3));

            allMarkers.push({ 
                marker, 
                type, 
                name: rawName,
                coords: coords,
                events: eventsData
            });
        }

        function determineGroupType(name) {
            const n = name.toLowerCase();
            if (n.includes("fomc") || n.includes("working group")) return "fomc"; 
            if (n.includes("partner") || n.includes("friends of") || n.includes("catchment")) return "partner"; 
            return "other"; 
        }

        function findEventsForGroup(rawMapName) {
            const now = new Date();
            const coreName = rawMapName.replace(/FOMC @\s*|Friends of\s*|The\s*/gi, "").trim().toLowerCase();

            // Find all matching events
            const groupEvents = calendarEvents.filter(e => {
                const loc = (e.location || "").toLowerCase();
                const sum = (e.summary || "").toLowerCase();
                const locMatch = loc.includes(coreName) || (loc.length > 5 && coreName.includes(loc));
                const sumMatch = sum.includes(coreName);
                return locMatch || sumMatch;
            });

            groupEvents.sort((a, b) => a.startDate - b.startDate);

            const past = groupEvents.filter(e => e.startDate < now);
            const future = groupEvents.filter(e => e.startDate >= now);
            
            // For Hotspot: Count events in range (Past 12mo to Future 3mo)
            const yearAgo = new Date(); yearAgo.setFullYear(now.getFullYear() - 1);
            const threeMonthsFuture = new Date(); threeMonthsFuture.setMonth(now.getMonth() + 3);
            
            const hotspotCount = groupEvents.filter(e => e.startDate >= yearAgo && e.startDate <= threeMonthsFuture).length;

            return {
                all: groupEvents,
                past: past,
                future: future,
                hotspotCount: hotspotCount
            };
        }

        function generatePopupHtml(name, type, nextEvents) {
            let typeLabel = type === 'fomc' ? 'Working Group' : (type === 'partner' ? 'Partner Group' : 'Activity Site');
            
            let eventsHtml = '';
            if (nextEvents.length > 0) {
                eventsHtml = `<div class="popup-events-list">`;
                nextEvents.forEach(e => {
                    eventsHtml += `
                        <div class="popup-event">
                            <span class="event-date">${e.startDate.toLocaleDateString()}</span>
                            <span class="event-title">${e.summary}</span>
                        </div>`;
                });
                eventsHtml += `</div>`;
            } else {
                eventsHtml = `<div class="popup-event" style="border-left-color:#ccc;">No upcoming events.</div>`;
            }

            return `<div class="popup-header">${name}</div>
                    <div class="popup-sub">${typeLabel}</div>
                    ${eventsHtml}`;
        }

        // --- UI GENERATORS ---

        function generateGroupList() {
            const container = document.getElementById('group-list-container');
            // Sort by name
            const sorted = [...allMarkers].sort((a,b) => a.name.localeCompare(b.name));
            
            sorted.forEach(item => {
                const li = document.createElement('li');
                li.className = 'group-list-item';
                
                // Dot color
                let color = '#2ecc71';
                if(item.type === 'fomc') color = '#f1c40f';
                if(item.type === 'partner') color = '#9b59b6';
                
                li.innerHTML = `<div class="group-dot" style="background:${color}"></div>${item.name}`;
                
                li.onclick = () => {
                    map.flyTo(item.coords, 14, { duration: 1.5 });
                    item.marker.openPopup();
                };
                container.appendChild(li);
            });
        }

        function generateGlobalUpcomingList() {
            const container = document.getElementById('upcoming-list');
            const now = new Date();
            
            // STRATEGY: 
            // 1. Try to get matched events from markers
            let allFuture = [];
            allMarkers.forEach(m => {
                allFuture = allFuture.concat(m.events.future.map(e => ({...e, markerRef: m})));
            });
            
            // 2. Fallback: If no markers have events (maybe matching failed), 
            // check raw calendar data for ANY future events
            if (allFuture.length === 0 && calendarEvents.length > 0) {
                console.log("No marker matches found. Using raw calendar data.");
                allFuture = calendarEvents.filter(e => e.startDate >= now);
            }
            
            // Sort by date
            allFuture.sort((a,b) => a.startDate - b.startDate);
            
            // Take next 3
            const next3 = allFuture.slice(0, 3);
            
            container.innerHTML = "";
            if(next3.length === 0) {
                // If STILL empty, it means calendar fetch failed or data is empty
                container.innerHTML = "<div style='padding:15px; font-size:12px;'>No upcoming events found.</div>";
                return;
            }

            next3.forEach(e => {
                const div = document.createElement('div');
                div.className = 'upcoming-item';
                div.innerHTML = `
                    <span class="up-date">${e.startDate.toLocaleDateString()}</span>
                    <span class="up-title">${e.summary}</span>
                    <span class="up-loc">@ ${e.location || 'Unknown Location'}</span>
                `;
                div.onclick = () => {
                    // Only fly if we have a marker reference
                    if(e.markerRef) {
                        map.flyTo(e.markerRef.coords, 14);
                        e.markerRef.marker.openPopup();
                    } else {
                        // If raw event with no marker match, we can't fly anywhere
                        // Maybe alert or just do nothing
                        console.log("Event has no map location match.");
                    }
                };
                container.appendChild(div);
            });
        }

        // --- FILTER & VIEW LOGIC ---
        
        window.updateView = function() {
            const showFOMC = document.getElementById('chk-fomc').checked;
            const showPartner = document.getElementById('chk-partner').checked;
            const showOther = document.getElementById('chk-other').checked;
            const enableHotspot = document.getElementById('chk-hotspot').checked;

            // 1. Manage Markers vs Heatmap
            if (enableHotspot) {
                // HOTSPOT MODE
                // Hide Markers, Show Heatmap, Hide Popup Overlay
                allMarkers.forEach(m => map.removeLayer(m.marker));
                document.getElementById('upcoming-overlay').classList.add('hidden');
                
                if (!heatLayer) {
                    // Generate Heat Points: [lat, lng, intensity]
                    const heatPoints = allMarkers.map(m => [
                        m.coords[0], 
                        m.coords[1], 
                        Math.min(m.events.hotspotCount * 20, 100) // Scale: 5 events = max intensity
                    ]);
                    heatLayer = L.heatLayer(heatPoints, { radius: 35, blur: 20, maxZoom: 14 }).addTo(map);
                } else {
                    heatLayer.addTo(map);
                }

            } else {
                // STANDARD MODE
                // Show Markers, Hide Heatmap, Show Popup Overlay
                if (heatLayer) map.removeLayer(heatLayer);
                document.getElementById('upcoming-overlay').classList.remove('hidden');

                allMarkers.forEach(obj => {
                    let visible = false;
                    if (obj.type === 'fomc' && showFOMC) visible = true;
                    if (obj.type === 'partner' && showPartner) visible = true;
                    if (obj.type === 'other' && showOther) visible = true;

                    if (visible) obj.marker.addTo(map);
                    else map.removeLayer(obj.marker);
                });
            }
        }
    </script>
</body>
</html>
