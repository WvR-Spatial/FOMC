<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>FoMC Interactive Map</title>
    
    <!-- Leaflet CSS -->
    <link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css" integrity="sha256-p4NxAoJBhIIN+hmNHrzRCf9tD/miZyoHS5obTRR9BMY=" crossorigin=""/>
    
    <!-- Fonts -->
    <link href="https://fonts.googleapis.com/css2?family=Roboto:wght@400;500;700&display=swap" rel="stylesheet">

    <style>
        /* --- RESET & LAYOUT --- */
        body, html { margin: 0; padding: 0; height: 100%; width: 100%; font-family: 'Roboto', sans-serif; overflow: hidden; }
        #map { height: 100%; width: 100%; background: #f0f0f0; }

        /* --- UI CONTROLS (Unified Sidebar) --- */
        .map-controls {
            position: absolute;
            top: 15px;
            left: 15px;
            background: white;
            padding: 0;
            border-radius: 6px;
            box-shadow: 0 4px 15px rgba(0,0,0,0.15);
            z-index: 1000;
            width: 240px; 
            max-width: 80%;
            height: auto;
            max-height: 95vh;
            display: flex;
            flex-direction: column;
            font-size: 13px;
        }

        .controls-header {
            padding: 10px 15px;
            border-bottom: 1px solid #eee;
            background: #f8f9fa;
            border-radius: 6px 6px 0 0;
            display: flex;
            justify-content: space-between;
            align-items: center;
        }

        .controls-content {
            padding: 10px 15px;
            overflow-y: auto;
            flex-grow: 1;
        }

        .control-section { margin-bottom: 15px; border-bottom: 1px solid #eee; padding-bottom: 10px; }
        .control-section:last-child { border-bottom: none; margin-bottom: 0; padding-bottom: 0; }
        
        .control-title { font-weight: 700; margin-bottom: 8px; font-size: 12px; color: #2c3e50; text-transform: uppercase; letter-spacing: 0.5px; }
        
        /* Checkboxes */
        .filter-item { margin-bottom: 5px; display: flex; align-items: center; cursor: pointer; color: #444; }
        .filter-item input { margin-right: 8px; cursor: pointer; accent-color: #2c3e50; }
        
        /* Collapsible List */
        details summary { cursor: pointer; font-weight: 500; color: #2980b9; margin-bottom: 5px; outline: none; }
        details summary:hover { text-decoration: underline; }
        
        /* Group List */
        .group-list { list-style: none; padding: 0; margin: 0; max-height: 300px; overflow-y: auto; }
        .group-list-item { 
            padding: 4px 6px; 
            cursor: pointer; 
            border-radius: 4px; 
            color: #555; 
            transition: background 0.2s;
            display: flex;
            align-items: center;
        }
        .group-list-item:hover { background: #eef2f5; color: #000; }
        .group-dot { width: 8px; height: 8px; border-radius: 50%; margin-right: 8px; flex-shrink: 0;}

        /* --- PINS & POPUPS --- */
        .pin-swatch { width: 10px; height: 10px; border-radius: 50%; margin-right: 6px; border: 1px solid #ccc; }
        .pin-yellow { background: #f1c40f; } 
        .pin-purple { background: #9b59b6; } 
        .pin-green { background: #2ecc71; } 
        
        .custom-pin {
            background-color: #fff;
            border: 2px solid #fff;
            border-radius: 50%;
            box-shadow: 0 2px 5px rgba(0,0,0,0.4);
        }
        .custom-pin.type-fomc { background-color: #f1c40f; }
        .custom-pin.type-partner { background-color: #9b59b6; }
        .custom-pin.type-other { background-color: #2ecc71; }
        
        .popup-header { font-weight: bold; font-size: 15px; color: #2c3e50; margin-bottom: 5px; border-bottom: 2px solid #eee; padding-bottom: 5px;}
        .popup-sub { font-size: 11px; text-transform: uppercase; color: #7f8c8d; margin-bottom: 5px; letter-spacing: 0.5px; }
        
        /* --- PRINT STYLES --- */
        @media print {
            .map-controls { display: none !important; }
            .group-list-item, .custom-pin, .pin-swatch, .group-dot {
                -webkit-print-color-adjust: exact;
                print-color-adjust: exact;
            }
        }

        /* --- UTILS --- */
        #loader {
            position: absolute; top: 50%; left: 50%; transform: translate(-50%, -50%);
            background: rgba(255,255,255,0.95); padding: 20px; border-radius: 8px;
            z-index: 2000; box-shadow: 0 10px 30px rgba(0,0,0,0.2); text-align: center;
        }
    </style>
</head>
<body>

    <div id="loader">
        <h3 style="margin:0 0 10px 0; font-size:16px;">Loading Map</h3>
        <div style="font-size: 0.9em; color: #666;">Fetching Group Locations...</div>
        <div id="error-log" style="font-size:11px; color:red; margin-top:5px;"></div>
    </div>

    <div id="map"></div>

    <!-- UNIFIED LEFT SIDEBAR -->
    <div class="map-controls">
        <div class="controls-header">
            <strong style="font-size:14px;">Friends of Merri Creek</strong>
        </div>
        
        <div class="controls-content">
            
            <!-- 1. FILTERS -->
            <div class="control-section">
                <div class="control-title">Filters</div>
                <label class="filter-item">
                    <input type="checkbox" id="chk-fomc" checked onchange="updateView()"> 
                    <span class="pin-swatch pin-yellow"></span> Working Groups
                </label>
                <label class="filter-item">
                    <input type="checkbox" id="chk-partner" checked onchange="updateView()"> 
                    <span class="pin-swatch pin-purple"></span> Partner Groups
                </label>
                <label class="filter-item">
                    <input type="checkbox" id="chk-other" checked onchange="updateView()"> 
                    <span class="pin-swatch pin-green"></span> Activity Sites
                </label>
            </div>

            <!-- 2. ALL GROUPS (Collapsible & Sorted) -->
            <div class="control-section">
                <details open>
                    <summary class="control-title" style="display:list-item;">All Groups (Sorted South-North)</summary>
                    <ul id="group-list-container" class="group-list">
                        <!-- Populated by JS -->
                    </ul>
                </details>
            </div>
            
            <button onclick="window.print()" style="width:100%; padding:6px; cursor:pointer; background:#eee; border:1px solid #ccc; border-radius:4px; font-size:12px;">Print / Export View</button>
        </div>
    </div>

    <!-- SCRIPTS -->
    <script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js" integrity="sha256-20nQCchB9co0qIjJZRGuk2/Z9VM+kNiyxNV1lvTlZBo=" crossorigin=""></script>
    <script src="https://api.mapbox.com/mapbox.js/plugins/leaflet-omnivore/v0.3.1/leaflet-omnivore.min.js"></script>

    <script>
        // --- CONFIGURATION ---
        const CORS_PROXY = "https://corsproxy.io/?"; 
        const KML_URL = "https://www.google.com/maps/d/u/0/kml?mid=1N4_do_WC-ikYZ3nO9BO7oz343c51fZs&forcekml=1";
        
        let map;
        let allMarkers = []; 

        window.onload = init;

        async function init() {
            map = L.map('map', { zoomControl: false }).setView([-37.75, 144.98], 12); 
            L.control.zoom({ position: 'topright' }).addTo(map);
            L.tileLayer('https://{s}.basemaps.cartocdn.com/light_all/{z}/{x}/{y}{r}.png', {
                attribution: '&copy; OpenStreetMap &copy; CARTO',
                subdomains: 'abcd',
                maxZoom: 20
            }).addTo(map);

            await loadContextLayer(); 
            await loadMapPoints();    

            generateGroupList();

            document.getElementById('loader').style.display = 'none';
        }

        async function loadContextLayer() {
            const myRenderer = L.svg({ padding: 1.0 });
            try {
                const response = await fetch('./merriCatchment_boundary.geojson'); 
                if(response.ok) {
                    const data = await response.json();
                    renderBoundary(data, myRenderer);
                    return;
                }
                throw new Error("Local file not found");
            } catch (e) { 
                console.log("Using Fallback Boundary.");
                // Approximate fallback for preview
                const fallbackGeoJSON = { "type": "FeatureCollection", "features": [{ "type": "Feature", "geometry": { "type": "Polygon", "coordinates": [[ [144.96, -37.50], [145.02, -37.50], [145.05, -37.60], [145.02, -37.70], [145.00, -37.78], [144.98, -37.78], [144.95, -37.70], [144.92, -37.60], [144.96, -37.50] ]] } }] };
                renderBoundary(fallbackGeoJSON, myRenderer);
            }
        }

        function renderBoundary(data, renderer) {
            // 1. CREATE THE INVERSE MASK (The "Hole" Method)
            const tempLayer = L.geoJSON(data);
            const layers = tempLayer.getLayers();
            
            if (layers.length > 0) {
                // Get the coordinates of the catchment polygon
                // Leaflet's getLatLngs() returns Array of Arrays for polygons (Rings)
                // We assume the first feature is the main catchment
                let latlngs = layers[0].getLatLngs();
                
                // If it's a simple polygon, latlngs[0] is the outer ring.
                // We use this inner ring to cut a hole in the world map.
                const catchmentRing = Array.isArray(latlngs[0]) ? latlngs[0] : latlngs;

                // Define World Bounds (Outer Ring)
                const worldLatLngs = [
                    [-90, -180], [-90, 180], [90, 180], [90, -180]
                ];

                // Create Polygon: [Outer, Inner(Hole)]
                const inverseMask = L.polygon([worldLatLngs, catchmentRing], {
                    color: 'transparent',
                    fillColor: '#000',
                    fillOpacity: 0.45, // Darkens the outside world
                    interactive: false,
                    renderer: renderer
                }).addTo(map);
                inverseMask.bringToBack();
            }

            // 2. DRAW THE ACTUAL BOUNDARY LINE ON TOP
            // We draw this separately so it can have a color/outline without filling the middle
            L.geoJSON(data, {
                renderer: renderer,
                style: { 
                    color: "#2c3e50", 
                    weight: 3, 
                    fill: false, 
                    dashArray: '5, 5',
                    interactive: false 
                }
            }).addTo(map);

            // Fit bounds to catchment
            const bounds = tempLayer.getBounds();
            map.fitBounds(bounds, { padding: [20, 20] });
        }

        async function loadMapPoints() {
            try {
                const proxyUrl = CORS_PROXY + encodeURIComponent(KML_URL);
                const response = await fetch(proxyUrl);
                if (!response.ok) throw new Error("HTTP " + response.status);
                
                const kmlText = await response.text();
                const layer = omnivore.kml.parse(kmlText);
                const geojson = layer.toGeoJSON();
                
                geojson.features.forEach(feature => createSmartMarker(feature));

            } catch (e) {
                console.error("KML Error:", e);
                createSmartMarker({properties:{name:"FOMC @ Coburg Lake"}, geometry:{type:"Point", coordinates:[144.965, -37.733]}});
            }
        }

        // --- CORE LOGIC ---

        function createSmartMarker(feature) {
            const rawName = feature.properties.name || "Unknown";
            const type = determineGroupType(rawName);
            
            let lat, lng;
            if (feature.geometry.type === "Point") {
                lng = feature.geometry.coordinates[0];
                lat = feature.geometry.coordinates[1];
            } else return;
            
            const coords = [lat, lng]; 

            // Create Icon
            const iconClass = `custom-pin type-${type}`;
            const customIcon = L.divIcon({
                className: iconClass,
                iconSize: [14, 14],
                iconAnchor: [7, 7],
                popupAnchor: [0, -10]
            });

            const marker = L.marker(coords, {icon: customIcon}).addTo(map);
            
            // Simplified Popup
            marker.bindPopup(generatePopupHtml(rawName, type));

            // Add Click Behavior (Zoom/Pan) - SAME AS SIDEBAR
            marker.on('click', () => {
                map.flyTo(coords, 14, { duration: 1.5 });
            });

            allMarkers.push({ 
                marker, 
                type, 
                name: rawName,
                coords: coords
            });
        }

        function determineGroupType(name) {
            const n = name.toLowerCase();
            if (n.includes("fomc") || n.includes("working group")) return "fomc"; 
            if (n.includes("partner") || n.includes("friends of") || n.includes("catchment")) return "partner"; 
            return "other"; 
        }

        function generatePopupHtml(name, type) {
            let typeLabel = type === 'fomc' ? 'Working Group' : (type === 'partner' ? 'Partner Group' : 'Activity Site');
            return `<div class="popup-header">${name}</div><div class="popup-sub">${typeLabel}</div>`;
        }

        // --- UI GENERATORS ---

        function generateGroupList() {
            const container = document.getElementById('group-list-container');
            // SORTING: South to North (Ascending Latitude)
            const sorted = [...allMarkers].sort((a,b) => a.coords[0] - b.coords[0]);
            
            container.innerHTML = ""; // Clear existing
            
            sorted.forEach(item => {
                const li = document.createElement('li');
                li.className = 'group-list-item';
                
                let color = '#2ecc71';
                if(item.type === 'fomc') color = '#f1c40f';
                if(item.type === 'partner') color = '#9b59b6';
                
                li.innerHTML = `<div class="group-dot" style="background:${color}"></div>${item.name}`;
                
                li.onclick = () => {
                    map.flyTo(item.coords, 14, { duration: 1.5 });
                    item.marker.openPopup();
                };
                container.appendChild(li);
            });
        }

        // --- FILTER & VIEW LOGIC ---
        
        window.updateView = function() {
            const showFOMC = document.getElementById('chk-fomc').checked;
            const showPartner = document.getElementById('chk-partner').checked;
            const showOther = document.getElementById('chk-other').checked;

            allMarkers.forEach(obj => {
                let visible = false;
                if (obj.type === 'fomc' && showFOMC) visible = true;
                if (obj.type === 'partner' && showPartner) visible = true;
                if (obj.type === 'other' && showOther) visible = true;
                if (visible) obj.marker.addTo(map); else map.removeLayer(obj.marker);
            });
        }
    </script>
</body>
</html>
